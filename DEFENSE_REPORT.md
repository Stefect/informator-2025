# –ó–≤—ñ—Ç –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –ø—Ä–æ–µ–∫—Ç—É "Informator - –°–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≥–ª—è–¥—É –ø–æ—Ç–æ–∫—É"

## üìã –ó–º—ñ—Å—Ç
1. [–ó–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è](#–∑–∞–≥–∞–ª—å–Ω–∞-—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è)
2. [–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–∏](#–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º–∏)
3. [–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó](#–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ-—Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó)
4. [–ü–∞—Ç–µ—Ä–Ω–∏ –ø—Ä–æ–µ–∫—Ç—É–≤–∞–Ω–Ω—è](#–ø–∞—Ç–µ—Ä–Ω–∏-–ø—Ä–æ–µ–∫—Ç—É–≤–∞–Ω–Ω—è)
5. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Backend Server](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-backend-server)
6. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Capture Client](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-capture-client)
7. [–°—Ç—Ä—É–∫—Ç—É—Ä–∞ Frontend](#—Å—Ç—Ä—É–∫—Ç—É—Ä–∞-frontend)
8. [C++ Native Module](#c-native-module)
9. [–û–ø–∏—Å –∫–ª—é—á–æ–≤–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤](#–æ–ø–∏—Å-–∫–ª—é—á–æ–≤–∏—Ö-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤)
10. [–ê–ª–≥–æ—Ä–∏—Ç–º–∏ —Ç–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó](#–∞–ª–≥–æ—Ä–∏—Ç–º–∏-—Ç–∞-–æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó)
11. [–ë–µ–∑–ø–µ–∫–∞ —Ç–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è](#–±–µ–∑–ø–µ–∫–∞-—Ç–∞-–≤–∞–ª—ñ–¥–∞—Ü—ñ—è)
12. [–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è](#—Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏-—Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è)

---

## 1. –ó–∞–≥–∞–ª—å–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è

**–ù–∞–∑–≤–∞ –ø—Ä–æ–µ–∫—Ç—É:** Informator - Real-time Screen Capture & Streaming System

**–ú–µ—Ç–∞:** –†–æ–∑—Ä–æ–±–∫–∞ –≤–∏—Å–æ–∫–æ–ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ—ó —Å–∏—Å—Ç–µ–º–∏ –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è —Ç–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü—ñ—ó –µ–∫—Ä–∞–Ω—É –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ –∑ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ—é –∑–∞—Ç—Ä–∏–º–∫–æ—é.

**–ö–ª—é—á–æ–≤—ñ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:**
- üì∫ –†–æ–∑–¥—ñ–ª—å–Ω—ñ—Å—Ç—å: 2560x1440 (QHD)
- üé¨ –ß–∞—Å—Ç–æ—Ç–∞ –∫–∞–¥—Ä—ñ–≤: 30 FPS
- üóúÔ∏è JPEG –∫–æ–º–ø—Ä–µ—Å—ñ—è: 97.9% (14400 KB ‚Üí 300 KB)
- ‚ö° –ó–∞—Ç—Ä–∏–º–∫–∞: < 100ms
- üë• –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –Ω–µ–æ–±–º–µ–∂–µ–Ω–æ—ó –∫—ñ–ª—å–∫–æ—Å—Ç—ñ –≥–ª—è–¥–∞—á—ñ–≤

---

## 2. –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–∏

### 2.1 –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ö–µ–º–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     WebSocket      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Capture Client  ‚îÇ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê> ‚îÇ  Backend Server  ‚îÇ
‚îÇ  (DXGI Screen)  ‚îÇ   BGRA RAW Frames  ‚îÇ   (Node.js)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                               ‚îÇ
                                               ‚îÇ WebSocket
                                               ‚îÇ JPEG Frames
                                               ‚ñº
                                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                        ‚îÇ  Frontend Viewer ‚îÇ
                                        ‚îÇ   (Browser)      ‚îÇ
                                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2.2 –¢—Ä–∏—à–∞—Ä–æ–≤–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞

**1. Data Capture Layer (C++)**
- Windows DXGI API –¥–ª—è –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è –µ–∫—Ä–∞–Ω—É
- –ù–∞—Ç–∏–≤–Ω–∏–π –º–æ–¥—É–ª—å Node.js (N-API)
- –ü—Ä—è–º–∏–π –¥–æ—Å—Ç—É–ø –¥–æ GPU

**2. Processing Layer (Node.js)**
- WebSocket —Å–µ—Ä–≤–µ—Ä (ws library)
- JPEG –∫–æ–º–ø—Ä–µ—Å—ñ—è (Sharp library)
- –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞–º–∏ —Ç–∞ –ø–æ—Ç–æ–∫–∞–º–∏

**3. Presentation Layer (Browser)**
- Vanilla JavaScript (–±–µ–∑ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—ñ–≤)
- Canvas –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è
- WebSocket –∫–ª—ñ—î–Ω—Ç –¥–ª—è real-time

---

## 3. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó

### 3.1 Backend (Node.js + TypeScript)

```typescript
// package.json
{
  "dependencies": {
    "ws": "^8.18.0",           // WebSocket —Å–µ—Ä–≤–µ—Ä
    "express": "^5.0.0",       // HTTP —Å–µ—Ä–≤–µ—Ä
    "sharp": "^0.33.5",        // –û–±—Ä–æ–±–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω—å
    "dotenv": "^17.0.3",       // –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
    "winston": "^3.14.2"       // –õ–æ–≥—É–≤–∞–Ω–Ω—è
  },
  "devDependencies": {
    "typescript": "^5.2.0",    // –ö–æ–º–ø—ñ–ª—è—Ü—ñ—è TypeScript
    "@types/node": "^20.0.0",  // Type definitions
    "@types/ws": "^8.5.12"     // WebSocket types
  }
}
```

**–ß–æ–º—É TypeScript?**
- ‚úÖ –°—Ç–∞—Ç–∏—á–Ω–∞ —Ç–∏–ø—ñ–∑–∞—Ü—ñ—è ‚Üí –º–µ–Ω—à–µ –ø–æ–º–∏–ª–æ–∫
- ‚úÖ –ê–≤—Ç–æ–¥–æ–ø–æ–≤–Ω–µ–Ω–Ω—è –≤ IDE
- ‚úÖ –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–ø–µ—á–Ω–∏–π
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è —á–µ—Ä–µ–∑ —Ç–∏–ø–∏

### 3.2 Capture Client (Node.js + C++)

```javascript
// Native addon –∫–æ–º–ø—ñ–ª—è—Ü—ñ—è
{
  "scripts": {
    "build:native": "node-gyp rebuild"
  },
  "dependencies": {
    "ws": "^8.18.0"           // WebSocket –∫–ª—ñ—î–Ω—Ç
  }
}
```

**C++ Toolchain:**
- `node-gyp` - —Å–∏—Å—Ç–µ–º–∞ –∑–±—ñ—Ä–∫–∏
- `N-API` - —Å—Ç–∞–±—ñ–ª—å–Ω–∏–π API –¥–ª—è –Ω–∞—Ç–∏–≤–Ω–∏—Ö –º–æ–¥—É–ª—ñ–≤
- `DXGI` - DirectX Graphics Infrastructure
- `D3D11` - Direct3D 11 –¥–ª—è GPU –æ–ø–µ—Ä–∞—Ü—ñ–π

### 3.3 Frontend (Vanilla JavaScript)

```javascript
// –ë–µ–∑ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π - —á–∏—Å—Ç–∏–π JavaScript
- WebSocket API (–Ω–∞—Ç–∏–≤–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä)
- Canvas API (–Ω–∞—Ç–∏–≤–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä)
- Fetch API (–Ω–∞—Ç–∏–≤–Ω–∏–π –±—Ä–∞—É–∑–µ—Ä)
```

**–ü–µ—Ä–µ–≤–∞–≥–∏ –ø—ñ–¥—Ö–æ–¥—É:**
- ‚ö° –®–≤–∏–¥–∫—ñ—Å—Ç—å - –Ω–µ–º–∞—î overhead —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—ñ–≤
- üì¶ –†–æ–∑–º—ñ—Ä - 0 KB –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π
- üîß –ö–æ–Ω—Ç—Ä–æ–ª—å - –ø–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –∫–æ–¥–æ–º

---

## 4. –ü–∞—Ç–µ—Ä–Ω–∏ –ø—Ä–æ–µ–∫—Ç—É–≤–∞–Ω–Ω—è

### 4.1 Singleton Pattern

**–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è:** ClientManager, StreamManager, JPEGCompressor

```typescript
// –ü—Ä–∏–∫–ª–∞–¥: ClientManager
export class ClientManager {
    private clients: Map<string, ClientInfo> = new Map();
    
    // –Ñ–¥–∏–Ω–∏–π –µ–∫–∑–µ–º–ø–ª—è—Ä –¥–ª—è –≤—Å—å–æ–≥–æ –¥–æ–¥–∞—Ç–∫—É
    constructor() {
        logger.info('üë• ClientManager —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ');
    }
    
    addClient(clientId: string, ws: WebSocket, type: ClientType): void {
        // –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞–º–∏
    }
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –û–¥–∏–Ω –µ–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ –≤–µ—Å—å –¥–æ–¥–∞—Ç–æ–∫
- –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Å—Ç–∞–Ω–æ–º
- –ó—Ä—É—á–Ω–∏–π –¥–æ—Å—Ç—É–ø –∑ –±—É–¥—å-—è–∫–æ–≥–æ –º—ñ—Å—Ü—è

### 4.2 Observer Pattern (Event-Driven)

**–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è:** WebSocket –∑'—î–¥–Ω–∞–Ω–Ω—è, StreamManager events

```typescript
// StreamManager –≥–µ–Ω–µ—Ä—É—î –ø–æ–¥—ñ—ó
export class StreamManager extends EventEmitter {
    createStream(captureClientId: string): string {
        const streamId = generateStreamId();
        // ...
        this.emit('stream_created', { streamId, captureClientId });
        return streamId;
    }
}

// WebSocketHandler –ø—ñ–¥–ø–∏—Å—É—î—Ç—å—Å—è –Ω–∞ –ø–æ–¥—ñ—ó
this.streamManager.on('viewer_added', ({ streamId, viewerId }) => {
    // –†–µ–∞–≥—É—î–º–æ –Ω–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –≥–ª—è–¥–∞—á–∞
});
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –°–ª–∞–±–∫–∞ –∑–≤'—è–∑–∞–Ω—ñ—Å—Ç—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤
- –õ–µ–≥–∫–æ –¥–æ–¥–∞–≤–∞—Ç–∏ –Ω–æ–≤–∏—Ö —Å–ª—É—Ö–∞—á—ñ–≤
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è

### 4.3 Strategy Pattern

**–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è:** –í–∏–±—ñ—Ä –∫–æ–¥–µ–∫–∞ (BGRA RAW vs JPEG)

```typescript
// –°—Ç—Ä–∞—Ç–µ–≥—ñ—è –∫–æ–º–ø—Ä–µ—Å—ñ—ó
export class JPEGCompressor {
    async compress(bgraBuffer: Buffer, width: number, height: number): Promise<Buffer> {
        // –°—Ç—Ä–∞—Ç–µ–≥—ñ—è JPEG –∫–æ–º–ø—Ä–µ—Å—ñ—ó
        return sharp(bgraBuffer, { raw: { width, height, channels: 4 } })
            .removeAlpha()
            .jpeg({ quality: this.config.quality })
            .toBuffer();
    }
}
```

**–ú–æ–∂–ª–∏–≤—ñ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó:**
- BGRA RAW (–±–µ–∑ –∫–æ–º–ø—Ä–µ—Å—ñ—ó)
- JPEG (lossy, 97.9% —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è)
- H.264 (video codec, –º–∞–π–±—É—Ç–Ω—î)
- WebP (—Å—É—á–∞—Å–Ω—ñ—à–∏–π —Ñ–æ—Ä–º–∞—Ç)

### 4.4 Factory Pattern

**–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è:** –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è ID –¥–ª—è –∫–ª—ñ—î–Ω—Ç—ñ–≤ —Ç–∞ –ø–æ—Ç–æ–∫—ñ–≤

```typescript
// utils.ts
export function generateClientId(): string {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 12);
    return `client_${timestamp}_${random}`;
}

export function generateStreamId(): string {
    const timestamp = Date.now();
    const random = Math.random().toString(36).substring(2, 12);
    return `stream_${timestamp}_${random}`;
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –£–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π —Å–ø–æ—Å—ñ–± —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤
- –ì–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–æ —É–Ω—ñ–∫–∞–ª—å–Ω—ñ ID
- –õ–µ–≥–∫–æ –∑–º—ñ–Ω–∏—Ç–∏ –∞–ª–≥–æ—Ä–∏—Ç–º

### 4.5 Module Pattern

**–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è:** –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—è –∫–æ–¥—É –≤ –º–æ–¥—É–ª—ñ

```typescript
// constants.ts - –ú–æ–¥—É–ª—å –∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∞–º–∏
export const MESSAGE_TYPES = {
    IDENTIFICATION: 'identification',
    FRAME_METADATA: 'frame_metadata',
    // ...
} as const;

export const CLIENT_TYPES = {
    CAPTURE_CLIENT: 'capture_client',
    VIEWER: 'viewer'
} as const;
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –Ü–Ω–∫–∞–ø—Å—É–ª—è—Ü—ñ—è
- Namespace –∑–∞—Ö–∏—Å—Ç
- –ü–µ—Ä–µ—Å–ø–æ—Ä—è–¥–∫—É–≤–∞–Ω–Ω—è —ñ–º–ø–æ—Ä—Ç—ñ–≤

### 4.6 Facade Pattern

**–ó–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è:** WebSocketHandler —è–∫ —Ñ–∞—Å–∞–¥ –¥–ª—è –≤—Å—ñ—î—ó —Å–∏—Å—Ç–µ–º–∏

```typescript
export class WebSocketHandler {
    constructor(
        private wss: WebSocket.Server,
        private clientManager: ClientManager,
        private streamManager: StreamManager,
        private compressor: JPEGCompressor
    ) {
        // –Ñ–¥–∏–Ω–∞ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥—É –¥–ª—è –≤—Å—ñ—Ö WebSocket –æ–ø–µ—Ä–∞—Ü—ñ–π
        this.setupWebSocketServer();
        this.setupEventListeners();
    }
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –°–ø—Ä–æ—â–µ–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- –ü—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ
- –Ñ–¥–∏–Ω–∞ —Ç–æ—á–∫–∞ –≤—Ö–æ–¥—É

---

## 5. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Backend Server

### 5.1 –§–∞–π–ª–æ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
packages/backend-server/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts                 # Entry point
‚îÇ   ‚îú‚îÄ‚îÄ config.ts                # –ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
‚îÇ   ‚îú‚îÄ‚îÄ logger.ts                # Winston –ª–æ–≥—É–≤–∞–Ω–Ω—è
‚îÇ   ‚îú‚îÄ‚îÄ constants.ts             # –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏ (MESSAGE_TYPES, etc.)
‚îÇ   ‚îú‚îÄ‚îÄ types.ts                 # TypeScript —Ç–∏–ø–∏
‚îÇ   ‚îú‚îÄ‚îÄ utils.ts                 # –£—Ç–∏–ª—ñ—Ç–∞—Ä–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
‚îÇ   ‚îú‚îÄ‚îÄ client-manager.ts        # –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ stream-manager.ts        # –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–æ—Ç–æ–∫–∞–º–∏
‚îÇ   ‚îú‚îÄ‚îÄ jpeg-compressor.ts       # JPEG –∫–æ–º–ø—Ä–µ—Å—ñ—è
‚îÇ   ‚îî‚îÄ‚îÄ websocket-handler.ts     # WebSocket –ª–æ–≥—ñ–∫–∞
‚îú‚îÄ‚îÄ dist/                        # Compiled JavaScript
‚îî‚îÄ‚îÄ package.json
```

### 5.2 –ö–ª—é—á–æ–≤—ñ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏

#### 5.2.1 constants.ts - –¶–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏

```typescript
export const MESSAGE_TYPES = {
    IDENTIFICATION: 'identification',
    FRAME_METADATA: 'frame_metadata',
    FRAME_DATA: 'frame_data',
    JOIN_STREAM: 'join_stream',
    LEAVE_STREAM: 'leave_stream',
    START_CAPTURE: 'start_capture',
    STOP_CAPTURE: 'stop_capture',
    HEARTBEAT: 'heartbeat',
    COMMAND: 'command'
} as const;

export const CLIENT_TYPES = {
    CAPTURE_CLIENT: 'capture_client',
    VIEWER: 'viewer'
} as const;

export const FRAME_CODECS = {
    BGRA: 'bgra',
    JPEG: 'jpeg',
    H264: 'h264'
} as const;
```

**–ß–æ–º—É `as const`?**
- –†–æ–±–∏—Ç—å –æ–±'—î–∫—Ç immutable (readonly)
- TypeScript –≤–∏–≤–æ–¥–∏—Ç—å –ª—ñ—Ç–µ—Ä–∞–ª—å–Ω—ñ —Ç–∏–ø–∏
- –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –≤–∏–ø–∞–¥–∫–æ–≤–æ—ó –∑–º—ñ–Ω–∏

#### 5.2.2 types.ts - Type-safe —Ç–∏–ø–∏

```typescript
export type MessageType = typeof MESSAGE_TYPES[keyof typeof MESSAGE_TYPES];
export type ClientType = typeof CLIENT_TYPES[keyof typeof CLIENT_TYPES];
export type FrameCodec = typeof FRAME_CODECS[keyof typeof FRAME_CODECS];

export interface ClientInfo {
    clientId: string;
    ws: WebSocket;
    type: ClientType;
    connectedAt: number;
    lastActivity: number;
}

export interface StreamInfo {
    streamId: string;
    captureClientId: string;
    viewerIds: Set<string>;
    metadata: FrameMetadata | null;
    createdAt: number;
    stats: StreamStats;
}

export interface FrameMetadata {
    width: number;
    height: number;
    timestamp: number;
    frameNumber: number;
    size: number;
}
```

**Type Safety –ø–µ—Ä–µ–≤–∞–≥–∏:**
- –ê–≤—Ç–æ–¥–æ–ø–æ–≤–Ω–µ–Ω–Ω—è –≤ IDE
- –í–∏—è–≤–ª–µ–Ω–Ω—è –ø–æ–º–∏–ª–æ–∫ –Ω–∞ –µ—Ç–∞–ø—ñ –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è —á–µ—Ä–µ–∑ —Ç–∏–ø–∏

#### 5.2.3 client-manager.ts - –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç–∞–º–∏

```typescript
export class ClientManager {
    private clients: Map<string, ClientInfo> = new Map();

    addClient(clientId: string, ws: WebSocket, type: ClientType): void {
        const client: ClientInfo = {
            clientId,
            ws,
            type,
            connectedAt: Date.now(),
            lastActivity: Date.now()
        };
        this.clients.set(clientId, client);
        logger.info(`‚úÖ –ö–ª—ñ—î–Ω—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ: ${clientId} (—Ç–∏–ø: ${type})`);
    }

    removeClient(clientId: string): void {
        const client = this.clients.get(clientId);
        if (client) {
            this.clients.delete(clientId);
            logger.info(`‚ùå –ö–ª—ñ—î–Ω—Ç –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ: ${clientId} (${client.type})`);
        }
    }

    getClient(clientId: string): ClientInfo | undefined {
        return this.clients.get(clientId);
    }

    updateActivity(clientId: string): void {
        const client = this.clients.get(clientId);
        if (client) {
            client.lastActivity = Date.now();
        }
    }
}
```

**–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª:**
- –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –≤—Å—ñ—Ö –ø—ñ–¥–∫–ª—é—á–µ–Ω–∏—Ö –∫–ª—ñ—î–Ω—Ç—ñ–≤
- –¢–∏–ø—ñ–∑–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç—ñ–≤ (capture_client, viewer)
- Heartbeat –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –æ—á–∏—â–µ–Ω–Ω—è

#### 5.2.4 stream-manager.ts - –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–æ—Ç–æ–∫–∞–º–∏

```typescript
export class StreamManager extends EventEmitter {
    private streams: Map<string, StreamInfo> = new Map();

    createStream(captureClientId: string): string {
        const streamId = generateStreamId();
        const stream: StreamInfo = {
            streamId,
            captureClientId,
            viewerIds: new Set(),
            metadata: null,
            createdAt: Date.now(),
            stats: {
                framesReceived: 0,
                framesSent: 0,
                bytesReceived: 0,
                bytesSent: 0,
                startTime: Date.now()
            }
        };
        this.streams.set(streamId, stream);
        this.emit('stream_created', { streamId, captureClientId });
        return streamId;
    }

    addViewer(streamId: string, viewerId: string): void {
        const stream = this.streams.get(streamId);
        if (stream) {
            stream.viewerIds.add(viewerId);
            this.emit('viewer_added', { streamId, viewerId });
        }
    }

    recordFrameReceived(streamId: string, bytes: number): void {
        const stream = this.streams.get(streamId);
        if (stream) {
            stream.stats.framesReceived++;
            stream.stats.bytesReceived += bytes;
        }
    }
}
```

**–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª:**
- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø–æ—Ç–æ–∫—ñ–≤
- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è/–≤—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥–ª—è–¥–∞—á—ñ–≤
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (–∫–∞–¥—Ä–∏, —Ç—Ä–∞—Ñ—ñ–∫)
- –ü–æ–¥—ñ—ó –¥–ª—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ü—ñ—ó

#### 5.2.5 jpeg-compressor.ts - JPEG –∫–æ–º–ø—Ä–µ—Å—ñ—è

```typescript
export class JPEGCompressor {
    private config: CompressorConfig;
    private frameCount = 0;

    async compress(bgraBuffer: Buffer, width: number, height: number): Promise<Buffer> {
        this.frameCount++;

        // –ö–†–ò–¢–ò–ß–ù–û: BGRA ‚Üí RGBA –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è
        this.swapRedBlue(bgraBuffer);

        const jpegBuffer = await sharp(bgraBuffer, {
            raw: { width, height, channels: 4 }
        })
        .removeAlpha()  // RGBA ‚Üí RGB
        .jpeg({
            quality: this.config.quality,  // 75
            chromaSubsampling: '4:2:0',
            progressive: false,
            optimiseCoding: false
        })
        .toBuffer();

        return jpegBuffer;
    }

    // In-place swap —á–µ—Ä–≤–æ–Ω–æ–≥–æ —Ç–∞ —Å–∏–Ω—å–æ–≥–æ –∫–∞–Ω–∞–ª—ñ–≤
    private swapRedBlue(buffer: Buffer): void {
        for (let i = 0; i < buffer.length; i += 4) {
            const temp = buffer[i];      // B
            buffer[i] = buffer[i + 2];   // B ‚Üê R
            buffer[i + 2] = temp;        // R ‚Üê B
        }
    }
}
```

**–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó:**
- In-place swap (–±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–æ–≥–æ –±—É—Ñ–µ—Ä–∞)
- `progressive: false` - –±–∞–∑–æ–≤–∏–π JPEG
- `optimiseCoding: false` - —à–≤–∏–¥—à–µ
- `chromaSubsampling: '4:2:0'` - –º–µ–Ω—à–∏–π —Ä–æ–∑–º—ñ—Ä

**–ß–æ–º—É swapRedBlue?**
- Windows DXGI –ø–æ–≤–µ—Ä—Ç–∞—î BGRA
- Sharp/JPEG –æ—á—ñ–∫—É—î RGB
- –¢—Ä–µ–±–∞ –ø–æ–º—ñ–Ω—è—Ç–∏ R ‚Üî B

#### 5.2.6 websocket-handler.ts - WebSocket –ª–æ–≥—ñ–∫–∞

```typescript
export class WebSocketHandler {
    private pendingFrames: Map<string, FrameMetadata> = new Map();

    private async handleMessage(clientId: string, data: WebSocket.Data): Promise<void> {
        // –†–æ–∑—Ä—ñ–∑–Ω—è—î–º–æ —Ç–µ–∫—Å—Ç–æ–≤—ñ —Ç–∞ –±—ñ–Ω–∞—Ä–Ω—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        if (Buffer.isBuffer(data)) {
            try {
                // –°–ø—Ä–æ–±–∞ –ø–∞—Ä—Å–∏—Ç–∏ —è–∫ JSON
                const message = JSON.parse(data.toString());
                this.handleTextMessage(clientId, message);
            } catch {
                // –¶–µ binary frame
                await this.handleBinaryFrame(clientId, data);
            }
        }
    }

    private async handleBinaryFrame(clientId: string, frameData: Buffer): Promise<void> {
        // –û—Ç—Ä–∏–º–∞—Ç–∏ –º–µ—Ç–∞–¥–∞–Ω—ñ –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
        const metadata = this.pendingFrames.get(clientId);
        if (!metadata) return;

        this.pendingFrames.delete(clientId);

        // –ó–Ω–∞–π—Ç–∏ –ø–æ—Ç—ñ–∫
        const stream = this.streamManager.getStreamByCaptureClient(clientId);
        if (!stream) return;

        // –ö–æ–º–ø—Ä–µ—Å—É–≤–∞—Ç–∏ BGRA ‚Üí JPEG
        const compressedFrame = await this.compressor.compress(
            frameData,
            metadata.width,
            metadata.height
        );

        // –†–æ–∑—ñ—Å–ª–∞—Ç–∏ –≤—Å—ñ–º –≥–ª—è–¥–∞—á–∞–º
        const viewers = this.streamManager.getViewersForStream(stream.streamId);
        for (const viewerId of viewers) {
            const viewer = this.clientManager.getClient(viewerId);
            if (viewer && viewer.ws.readyState === WebSocket.OPEN) {
                // –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –º–µ—Ç–∞–¥–∞–Ω—ñ
                this.sendMessage(viewer.ws, {
                    type: MESSAGE_TYPES.FRAME_METADATA,
                    ...metadata,
                    size: compressedFrame.length,
                    codec: FRAME_CODECS.JPEG
                });
                // –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ JPEG –¥–∞–Ω—ñ
                viewer.ws.send(compressedFrame);
            }
        }
    }
}
```

**–ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—Ä–æ–±–∫–∏ –∫–∞–¥—Ä—É:**
1. Capture Client –Ω–∞–¥—Å–∏–ª–∞—î `frame_metadata` (JSON)
2. Backend –∑–±–µ—Ä—ñ–≥–∞—î –º–µ—Ç–∞–¥–∞–Ω—ñ –≤ `pendingFrames`
3. Capture Client –Ω–∞–¥—Å–∏–ª–∞—î binary frame (BGRA)
4. Backend –∑–Ω–∞—Ö–æ–¥–∏—Ç—å –º–µ—Ç–∞–¥–∞–Ω—ñ, –∫–æ–º–ø—Ä–µ—Å—É—î BGRA ‚Üí JPEG
5. Backend —Ä–æ–∑—Å–∏–ª–∞—î JPEG –≤—Å—ñ–º viewers

---

## 6. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Capture Client

### 6.1 –§–∞–π–ª–æ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
packages/capture-client/
‚îú‚îÄ‚îÄ index.js                     # –ì–æ–ª–æ–≤–Ω–∏–π —Ñ–∞–π–ª
‚îú‚îÄ‚îÄ native/
‚îÇ   ‚îú‚îÄ‚îÄ screen-capture.cpp       # DXGI –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è
‚îÇ   ‚îú‚îÄ‚îÄ screen-capture.h         # Header —Ñ–∞–π–ª
‚îÇ   ‚îú‚îÄ‚îÄ module.cpp               # N-API binding
‚îÇ   ‚îú‚îÄ‚îÄ encoder.cpp              # H.264 encoder (–Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è)
‚îÇ   ‚îî‚îÄ‚îÄ encoder.h
‚îú‚îÄ‚îÄ build/
‚îÇ   ‚îî‚îÄ‚îÄ Release/
‚îÇ       ‚îî‚îÄ‚îÄ screen_capture.node  # Compiled addon
‚îî‚îÄ‚îÄ binding.gyp                  # node-gyp config
```

### 6.2 index.js - JavaScript —á–∞—Å—Ç–∏–Ω–∞

```javascript
const WebSocket = require('ws');
const nativeCapture = require('./build/Release/screen_capture.node');

let captureWidth = 1280;   // –î–∏–Ω–∞–º—ñ—á–Ω–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è
let captureHeight = 720;

function initializeCapture() {
    const result = nativeCapture.initialize({
        width: 1280,
        height: 720,
        fps: 30,
        bitrate: 0,
        useHardware: false
    });

    if (result.success) {
        // –í–ê–ñ–õ–ò–í–û: –∑–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∞–ª—å–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏
        captureWidth = result.width;   // 2560
        captureHeight = result.height; // 1440
        console.log(`‚úÖ –ó–∞—Ö–æ–ø–ª–µ–Ω–Ω—è: ${captureWidth}x${captureHeight} @ 30 FPS`);
    }
}

function captureAndSendFrame() {
    frameNumber++;
    
    const result = nativeCapture.captureFrame();
    
    if (result.success && result.data) {
        sendFrame(result.data, result.size, result.encoded || false);
    }
}

function sendFrame(frameData, size, isEncoded) {
    // –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –º–µ—Ç–∞–¥–∞–Ω—ñ
    const metadata = {
        type: 'frame_metadata',
        width: captureWidth,      // –†–µ–∞–ª—å–Ω–∏–π —Ä–æ–∑–º—ñ—Ä!
        height: captureHeight,
        timestamp: Date.now(),
        frameNumber: frameNumber,
        size: size,
        encoded: isEncoded,
        codec: isEncoded ? 'h264' : 'bgra'
    };
    ws.send(JSON.stringify(metadata));
    
    // –í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ binary –¥–∞–Ω—ñ
    ws.send(frameData);
}
```

**–ö–ª—é—á–æ–≤—ñ –º–æ–º–µ–Ω—Ç–∏:**
- –î–∏–Ω–∞–º—ñ—á–Ω–µ –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è —Ä–æ–∑–º—ñ—Ä—É –µ–∫—Ä–∞–Ω—É
- –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –º–µ—Ç–∞–¥–∞–Ω–∏—Ö + binary –æ–∫—Ä–µ–º–æ
- 30 FPS (33ms —ñ–Ω—Ç–µ—Ä–≤–∞–ª)

---

## 7. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ Frontend

### 7.1 –§–∞–π–ª–æ–≤–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
packages/frontend/public/
‚îú‚îÄ‚îÄ index.html                   # –ì–æ–ª–æ–≤–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞
‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îî‚îÄ‚îÄ styles.css              # –°—Ç–∏–ª—ñ
‚îî‚îÄ‚îÄ js/
    ‚îú‚îÄ‚îÄ websocket-client.js     # WebSocket –∫–ª—ñ—î–Ω—Ç
    ‚îî‚îÄ‚îÄ stream-player.js        # Canvas rendering
```

### 7.2 websocket-client.js - WebSocket –∫–ª—ñ—î–Ω—Ç

```javascript
let ws = null;
let isConnected = false;
let currentStreamId = null;

function connect() {
    ws = new WebSocket(wsUrl);
    
    ws.onopen = () => {
        log('‚úÖ –ó\'—î–¥–Ω–∞–Ω–æ –∑ —Å–µ—Ä–≤–µ—Ä–æ–º');
        isConnected = true;
        sendIdentification();
    };
    
    ws.onmessage = (event) => {
        if (typeof event.data === 'string') {
            // JSON –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
            const message = JSON.parse(event.data);
            handleMessage(message);
        } else {
            // Binary frame (JPEG)
            handleFrame(event.data);
        }
    };
}

function sendIdentification() {
    ws.send(JSON.stringify({
        type: 'identification',
        clientType: 'viewer'
    }));
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–Ω–∞–π—Ç–∏ —Å—Ç—Ä—ñ–º–∏
    setTimeout(() => {
        requestAvailableStreams();
    }, 500);
}

async function requestAvailableStreams() {
    const response = await fetch(`${httpUrl}/api/streams`);
    const data = await response.json();
    
    if (data.streams.length > 0) {
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –¥–æ –ø–µ—Ä—à–æ–≥–æ —Å—Ç—Ä—ñ–º—É
        joinStream(data.streams[0].streamId);
    }
}
```

**–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª:**
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è —Å—Ç—Ä—ñ–º—ñ–≤
- –û–±—Ä–æ–±–∫–∞ JSON —Ç–∞ Binary –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

### 7.3 stream-player.js - Canvas rendering

```javascript
const canvas = document.getElementById('streamCanvas');
const ctx = canvas.getContext('2d');
let frameCount = 0;

function handleFrame(arrayBuffer) {
    frameCount++;
    
    // –°—Ç–≤–æ—Ä–∏—Ç–∏ Blob –∑ JPEG –¥–∞–Ω–∏—Ö
    const blob = new Blob([arrayBuffer], { type: 'image/jpeg' });
    const url = URL.createObjectURL(blob);
    
    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —è–∫ Image
    const img = new Image();
    img.onload = () => {
        // –ú–∞–ª—é–≤–∞—Ç–∏ –Ω–∞ canvas
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        URL.revokeObjectURL(url);
        
        updateStats();
    };
    img.src = url;
}

function updateStats() {
    const now = Date.now();
    const elapsed = (now - startTime) / 1000;
    const fps = (frameCount / elapsed).toFixed(1);
    
    document.getElementById('fpsValue').textContent = fps;
    document.getElementById('framesValue').textContent = frameCount;
}
```

**–û–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó:**
- `URL.createObjectURL()` - —à–≤–∏–¥—à–µ –∑–∞ base64
- `URL.revokeObjectURL()` - –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è –ø–∞–º'—è—Ç—ñ
- Canvas API - –∞–ø–∞—Ä–∞—Ç–Ω–µ –ø—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è

---

## 8. C++ Native Module

### 8.1 screen-capture.cpp - DXGI –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è

```cpp
class ScreenCapture {
private:
    ID3D11Device* d3d_device_ = nullptr;
    ID3D11DeviceContext* d3d_context_ = nullptr;
    IDXGIOutputDuplication* dxgi_duplication_ = nullptr;
    ID3D11Texture2D* staging_texture_ = nullptr;
    
    int desktop_width_;
    int desktop_height_;
    int width_;
    int height_;

public:
    bool Initialize(int width, int height) {
        // 1. –°—Ç–≤–æ—Ä–∏—Ç–∏ D3D11 device
        D3D11CreateDevice(nullptr, D3D_DRIVER_TYPE_HARDWARE, ...);
        
        // 2. –û—Ç—Ä–∏–º–∞—Ç–∏ DXGI adapter
        IDXGIAdapter* dxgi_adapter;
        device->QueryInterface(__uuidof(IDXGIAdapter), ...);
        
        // 3. –û—Ç—Ä–∏–º–∞—Ç–∏ output (–º–æ–Ω—ñ—Ç–æ—Ä)
        IDXGIOutput* dxgi_output;
        adapter->EnumOutputs(0, &dxgi_output);
        
        // 4. –°—Ç–≤–æ—Ä–∏—Ç–∏ duplication
        IDXGIOutput1* output1;
        output->QueryInterface(__uuidof(IDXGIOutput1), ...);
        output1->DuplicateOutput(device, &dxgi_duplication_);
        
        // 5. –û—Ç—Ä–∏–º–∞—Ç–∏ —Ä–æ–∑–º—ñ—Ä –µ–∫—Ä–∞–Ω—É
        DXGI_OUTDUPL_DESC dupl_desc;
        dxgi_duplication_->GetDesc(&dupl_desc);
        desktop_width_ = dupl_desc.ModeDesc.Width;   // 2560
        desktop_height_ = dupl_desc.ModeDesc.Height; // 1440
        
        // –í–ê–ñ–õ–ò–í–û: –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ø–æ–≤–Ω–∏–π —Ä–æ–∑–º—ñ—Ä!
        width_ = desktop_width_;
        height_ = desktop_height_;
        
        // 6. –°—Ç–≤–æ—Ä–∏—Ç–∏ staging texture –¥–ª—è CPU –¥–æ—Å—Ç—É–ø—É
        D3D11_TEXTURE2D_DESC texture_desc = {};
        texture_desc.Width = width_;
        texture_desc.Height = height_;
        texture_desc.Format = DXGI_FORMAT_B8G8R8A8_UNORM;  // BGRA
        texture_desc.Usage = D3D11_USAGE_STAGING;
        texture_desc.CPUAccessFlags = D3D11_CPU_ACCESS_READ;
        
        device->CreateTexture2D(&texture_desc, nullptr, &staging_texture_);
    }

    bool CaptureFrame(std::vector<uint8_t>& frame_data) {
        IDXGIResource* desktop_resource;
        DXGI_OUTDUPL_FRAME_INFO frame_info;
        
        // –ó–∞—Ö–æ–ø–∏—Ç–∏ –∫–∞–¥—Ä
        HRESULT hr = dxgi_duplication_->AcquireNextFrame(
            0,  // timeout
            &frame_info,
            &desktop_resource
        );
        
        if (FAILED(hr)) return false;
        
        // –ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏ –¥–æ ID3D11Texture2D
        ID3D11Texture2D* desktop_texture;
        desktop_resource->QueryInterface(&desktop_texture);
        
        // –ö–æ–ø—ñ—é–≤–∞—Ç–∏ –≤ staging (GPU ‚Üí CPU)
        d3d_context_->CopyResource(staging_texture_, desktop_texture);
        
        // Map staging texture –¥–ª—è —á–∏—Ç–∞–Ω–Ω—è
        D3D11_MAPPED_SUBRESOURCE mapped_resource;
        d3d_context_->Map(staging_texture_, 0, D3D11_MAP_READ, 0, &mapped_resource);
        
        // –ö–æ–ø—ñ—é–≤–∞—Ç–∏ BGRA –¥–∞–Ω—ñ
        const size_t frame_size = width_ * height_ * 4;
        frame_data.resize(frame_size);
        
        uint8_t* src = static_cast<uint8_t*>(mapped_resource.pData);
        uint8_t* dst = frame_data.data();
        
        for (int row = 0; row < height_; ++row) {
            memcpy(dst, src, width_ * 4);
            src += mapped_resource.RowPitch;
            dst += width_ * 4;
        }
        
        d3d_context_->Unmap(staging_texture_, 0);
        dxgi_duplication_->ReleaseFrame();
        
        return true;
    }
};
```

**–ê–ª–≥–æ—Ä–∏—Ç–º –∑–∞—Ö–æ–ø–ª–µ–Ω–Ω—è:**
1. `DuplicateOutput()` - —Å—Ç–≤–æ—Ä–∏—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç –≤–∏–≤–æ–¥—É –º–æ–Ω—ñ—Ç–æ—Ä–∞
2. `AcquireNextFrame()` - –∑–∞—Ö–æ–ø–∏—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫–∞–¥—Ä –∑ GPU
3. `CopyResource()` - –∫–æ–ø—ñ—é–≤–∞—Ç–∏ –≤ staging (GPU ‚Üí CPU –¥–æ—Å—Ç—É–ø)
4. `Map()` - –æ—Ç—Ä–∏–º–∞—Ç–∏ pointer –Ω–∞ CPU –ø–∞–º'—è—Ç—å
5. `memcpy()` - –∫–æ–ø—ñ—é–≤–∞—Ç–∏ BGRA –¥–∞–Ω—ñ
6. `Unmap()` - –∑–≤—ñ–ª—å–Ω–∏—Ç–∏ –¥–æ—Å—Ç—É–ø
7. `ReleaseFrame()` - –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∫–∞–¥—Ä

**DXGI –ø–µ—Ä–µ–≤–∞–≥–∏:**
- ‚ö° –®–≤–∏–¥–∫–æ - –ø—Ä—è–º–∏–π –¥–æ—Å—Ç—É–ø –¥–æ GPU
- üéØ –¢–æ—á–Ω–æ - pixel-perfect –∫–æ–ø—ñ—è
- üîí –ë–µ–∑–ø–µ—á–Ω–æ - Windows API
- üí™ –ï—Ñ–µ–∫—Ç–∏–≤–Ω–æ - zero-copy –Ω–∞ GPU

### 8.2 module.cpp - N-API binding

```cpp
napi_value Initialize(napi_env env, napi_callback_info info) {
    // –û—Ç—Ä–∏–º–∞—Ç–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–∏
    size_t argc = 1;
    napi_value args[1];
    napi_get_cb_info(env, info, &argc, args, nullptr, nullptr);
    
    // –ü–∞—Ä—Å–∏—Ç–∏ config object
    napi_value width_value, height_value, fps_value;
    napi_get_named_property(env, args[0], "width", &width_value);
    napi_get_named_property(env, args[0], "height", &height_value);
    napi_get_named_property(env, args[0], "fps", &fps_value);
    
    int width, height, fps;
    napi_get_value_int32(env, width_value, &width);
    napi_get_value_int32(env, height_value, &height);
    napi_get_value_int32(env, fps_value, &fps);
    
    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ capture
    bool success = g_screen_capture.Initialize(width, height);
    
    // –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    napi_value result;
    napi_create_object(env, &result);
    
    napi_value success_value;
    napi_get_boolean(env, success, &success_value);
    napi_set_named_property(env, result, "success", success_value);
    
    // –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ —Ä–µ–∞–ª—å–Ω—ñ —Ä–æ–∑–º—ñ—Ä–∏!
    napi_value actual_width, actual_height;
    napi_create_int32(env, g_screen_capture.GetWidth(), &actual_width);
    napi_create_int32(env, g_screen_capture.GetHeight(), &actual_height);
    napi_set_named_property(env, result, "width", actual_width);
    napi_set_named_property(env, result, "height", actual_height);
    
    return result;
}

napi_value CaptureFrame(napi_env env, napi_callback_info info) {
    std::vector<uint8_t> frame_data;
    bool success = g_screen_capture.CaptureFrame(frame_data);
    
    if (!success) {
        // –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –ø–æ–º–∏–ª–∫—É
        napi_value result;
        napi_create_object(env, &result);
        napi_value success_value;
        napi_get_boolean(env, false, &success_value);
        napi_set_named_property(env, result, "success", success_value);
        return result;
    }
    
    // –°—Ç–≤–æ—Ä–∏—Ç–∏ Node.js Buffer –∑ BGRA –¥–∞–Ω–∏—Ö
    napi_value buffer;
    void* buffer_data;
    napi_create_buffer_copy(env, frame_data.size(), frame_data.data(), 
                           &buffer_data, &buffer);
    
    // –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    napi_value result;
    napi_create_object(env, &result);
    
    napi_value success_value;
    napi_get_boolean(env, true, &success_value);
    napi_set_named_property(env, result, "success", success_value);
    napi_set_named_property(env, result, "data", buffer);
    
    napi_value size_value;
    napi_create_int32(env, frame_data.size(), &size_value);
    napi_set_named_property(env, result, "size", size_value);
    
    return result;
}

// –ï–∫—Å–ø–æ—Ä—Ç —Ñ—É–Ω–∫—Ü—ñ–π
napi_value Init(napi_env env, napi_value exports) {
    napi_value initialize_fn, capture_frame_fn;
    
    napi_create_function(env, "initialize", NAPI_AUTO_LENGTH, 
                        Initialize, nullptr, &initialize_fn);
    napi_create_function(env, "captureFrame", NAPI_AUTO_LENGTH, 
                        CaptureFrame, nullptr, &capture_frame_fn);
    
    napi_set_named_property(env, exports, "initialize", initialize_fn);
    napi_set_named_property(env, exports, "captureFrame", capture_frame_fn);
    
    return exports;
}

NAPI_MODULE(NODE_GYP_MODULE_NAME, Init)
```

**N-API –ø–µ—Ä–µ–≤–∞–≥–∏:**
- ‚úÖ –°—Ç–∞–±—ñ–ª—å–Ω–∏–π ABI (–Ω–µ —Ç—Ä–µ–±–∞ –ø–µ—Ä–µ–∫–æ–º–ø—ñ–ª—é–≤–∞—Ç–∏ –¥–ª—è –Ω–æ–≤–∏—Ö Node.js)
- ‚úÖ –û—Ñ—ñ—Ü—ñ–π–Ω–∏–π API
- ‚úÖ –•–æ—Ä–æ—à–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—è
- ‚úÖ Type-safe

---

## 9. –û–ø–∏—Å –∫–ª—é—á–æ–≤–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤

### 9.1 –ü—Ä–æ—Ç–æ–∫–æ–ª –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—ó

**WebSocket –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è:**

```typescript
// 1. –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç–∞
{
    type: 'identification',
    clientType: 'capture_client' | 'viewer'
}

// 2. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å—Ç—Ä—ñ–º—É (Backend ‚Üí Capture Client)
{
    type: 'stream_created',
    streamId: 'stream_1234567890_abc123',
    timestamp: 1698765432100
}

// 3. –ú–µ—Ç–∞–¥–∞–Ω—ñ –∫–∞–¥—Ä—É (Capture Client ‚Üí Backend)
{
    type: 'frame_metadata',
    width: 2560,
    height: 1440,
    timestamp: 1698765432100,
    frameNumber: 42,
    size: 14745600,  // bytes
    codec: 'bgra'
}

// 4. Binary frame (Buffer)
<14745600 bytes BGRA data>

// 5. –ü—Ä–∏—î–¥–Ω–∞–Ω–Ω—è –¥–æ —Å—Ç—Ä—ñ–º—É (Viewer ‚Üí Backend)
{
    type: 'join_stream',
    streamId: 'stream_1234567890_abc123'
}

// 6. –ú–µ—Ç–∞–¥–∞–Ω—ñ –∫–∞–¥—Ä—É –¥–ª—è viewer (Backend ‚Üí Viewer)
{
    type: 'frame_metadata',
    width: 2560,
    height: 1440,
    timestamp: 1698765432100,
    frameNumber: 42,
    size: 307200,  // compressed JPEG
    codec: 'jpeg'
}

// 7. Binary JPEG frame (Buffer)
<307200 bytes JPEG data>
```

### 9.2 –ñ–∏—Ç—Ç—î–≤–∏–π —Ü–∏–∫–ª –∫–∞–¥—Ä—É

```
[Capture Client]                [Backend]                [Viewer]
      ‚îÇ                             ‚îÇ                         ‚îÇ
      ‚îÇ 1. captureFrame()           ‚îÇ                         ‚îÇ
      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>               ‚îÇ                         ‚îÇ
      ‚îÇ    DXGI ‚Üí BGRA              ‚îÇ                         ‚îÇ
      ‚îÇ    (14400 KB)               ‚îÇ                         ‚îÇ
      ‚îÇ                             ‚îÇ                         ‚îÇ
      ‚îÇ 2. frame_metadata (JSON)    ‚îÇ                         ‚îÇ
      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                         ‚îÇ
      ‚îÇ                             ‚îÇ                         ‚îÇ
      ‚îÇ 3. Binary BGRA              ‚îÇ                         ‚îÇ
      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                         ‚îÇ
      ‚îÇ                             ‚îÇ                         ‚îÇ
      ‚îÇ                             ‚îÇ 4. swapRedBlue()        ‚îÇ
      ‚îÇ                             ‚îÇ    BGRA ‚Üí RGBA          ‚îÇ
      ‚îÇ                             ‚îÇ                         ‚îÇ
      ‚îÇ                             ‚îÇ 5. Sharp JPEG           ‚îÇ
      ‚îÇ                             ‚îÇ    RGBA ‚Üí RGB ‚Üí JPEG    ‚îÇ
      ‚îÇ                             ‚îÇ    (300 KB)             ‚îÇ
      ‚îÇ                             ‚îÇ                         ‚îÇ
      ‚îÇ                             ‚îÇ 6. frame_metadata       ‚îÇ
      ‚îÇ                             ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚îÇ                             ‚îÇ                         ‚îÇ
      ‚îÇ                             ‚îÇ 7. Binary JPEG          ‚îÇ
      ‚îÇ                             ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚îÇ                             ‚îÇ                         ‚îÇ
      ‚îÇ                             ‚îÇ                    8. Canvas
      ‚îÇ                             ‚îÇ                    Render
```

**–ß–∞—Å –≤–∏–∫–æ–Ω–∞–Ω–Ω—è:**
- DXGI CaptureFrame: ~5ms
- WebSocket –ø–µ—Ä–µ–¥–∞—á–∞ BGRA: ~10ms
- JPEG –∫–æ–º–ø—Ä–µ—Å—ñ—è: ~15ms
- WebSocket –ø–µ—Ä–µ–¥–∞—á–∞ JPEG: ~3ms
- Canvas render: ~5ms
- **–ó–∞–≥–∞–ª—å–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞: ~40ms**

### 9.3 –£–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–∞–º'—è—Ç—Ç—é

**C++ Side:**
```cpp
// RAII pattern –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ –æ—á–∏—â–µ–Ω–Ω—è
class ScreenCapture {
    ~ScreenCapture() {
        if (staging_texture_) staging_texture_->Release();
        if (dxgi_duplication_) dxgi_duplication_->Release();
        if (d3d_context_) d3d_context_->Release();
        if (d3d_device_) d3d_device_->Release();
    }
};

// –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è std::vector –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è
std::vector<uint8_t> frame_data;  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–≤—ñ–ª—å–Ω–∏—Ç—å—Å—è
```

**Node.js Side:**
```javascript
// Garbage Collector –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ—á–∏—â–∞—î Buffers
ws.onmessage = (event) => {
    // event.data –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å—Ç–∞–Ω–µ garbage –ø—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è
};
```

**Browser Side:**
```javascript
// –Ø–≤–Ω–µ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è Blob URLs
const url = URL.createObjectURL(blob);
// ... –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è ...
URL.revokeObjectURL(url);  // –ó–≤—ñ–ª—å–Ω–∏—Ç–∏ –ø–∞–º'—è—Ç—å!
```

---

## 10. –ê–ª–≥–æ—Ä–∏—Ç–º–∏ —Ç–∞ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó

### 10.1 BGRA ‚Üí RGB –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è

**–ü—Ä–æ–±–ª–µ–º–∞:** DXGI –ø–æ–≤–µ—Ä—Ç–∞—î BGRA, –∞–ª–µ JPEG –æ—á—ñ–∫—É—î RGB.

**–ù–∞—ó–≤–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è (–ü–û–í–Ü–õ–¨–ù–û):**
```javascript
// –°—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –Ω–æ–≤–∏–π buffer - O(n) –ø–∞–º'—è—Ç—å + O(n) —á–∞—Å
function convertBGRAtoRGB(bgra) {
    const rgb = Buffer.alloc(bgra.length / 4 * 3);
    for (let i = 0; i < bgra.length; i += 4) {
        rgb[j++] = bgra[i + 2];  // R
        rgb[j++] = bgra[i + 1];  // G
        rgb[j++] = bgra[i];      // B
    }
    return rgb;
}
```

**–ù–∞—à–µ —Ä—ñ—à–µ–Ω–Ω—è (–®–í–ò–î–ö–û):**
```javascript
// In-place swap - O(1) –ø–∞–º'—è—Ç—å + O(n) —á–∞—Å
function swapRedBlue(buffer) {
    for (let i = 0; i < buffer.length; i += 4) {
        const temp = buffer[i];      // B
        buffer[i] = buffer[i + 2];   // B ‚Üê R
        buffer[i + 2] = temp;        // R ‚Üê B
    }
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- ‚úÖ –ù–µ–º–∞—î –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó –ø–∞–º'—è—Ç—ñ
- ‚úÖ Cache-friendly (–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–∏–π –¥–æ—Å—Ç—É–ø)
- ‚úÖ –®–≤–∏–¥—à–µ –≤ 2 —Ä–∞–∑–∏

### 10.2 JPEG –ø–∞—Ä–∞–º–µ—Ç—Ä–∏

```typescript
{
    quality: 75,                    // –ë–∞–ª–∞–Ω—Å —è–∫—ñ—Å—Ç—å/—Ä–æ–∑–º—ñ—Ä
    chromaSubsampling: '4:2:0',     // –°—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è –≤—ñ–¥–µ–æ
    progressive: false,             // –ë–∞–∑–æ–≤–∏–π JPEG (—à–≤–∏–¥—à–µ)
    optimiseCoding: false           // –ë–µ–∑ –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—ó (—à–≤–∏–¥—à–µ)
}
```

**–ß–æ–º—É —Ü—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏?**

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–Ω—è | –ü—Ä–∏—á–∏–Ω–∞ |
|----------|----------|---------|
| quality | 75 | –ó–æ–ª–æ—Ç–∞ —Å–µ—Ä–µ–¥–∏–Ω–∞ (–≤–∏—â–µ 80 - –º–∞–ª–æ –≤–∏–≥—Ä–∞—à—É, –Ω–∏–∂—á–µ 70 - –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∏) |
| chromaSubsampling | 4:2:0 | –õ—é–¥—Å—å–∫–µ –æ–∫–æ –º–µ–Ω—à —á—É—Ç–ª–∏–≤–µ –¥–æ –∫–æ–ª—å–æ—Ä—É –Ω—ñ–∂ —è—Å–∫—Ä–∞–≤–æ—Å—Ç—ñ |
| progressive | false | –ü—Ä–æ–≥—Ä–µ—Å–∏–≤–Ω–∏–π JPEG –ø–æ–≤—ñ–ª—å–Ω—ñ—à–µ –∫–æ–¥—É—î—Ç—å—Å—è |
| optimiseCoding | false | Huffman –æ–ø—Ç–∏–º—ñ–∑–∞—Ü—ñ—è –¥–æ–¥–∞—î 10-15% –¥–æ —á–∞—Å—É |

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –†–æ–∑–º—ñ—Ä: 14400 KB ‚Üí 300 KB (97.9% —Å—Ç–∏—Å–Ω–µ–Ω–Ω—è)
- –ß–∞—Å: ~15ms –Ω–∞ –∫–∞–¥—Ä
- –Ø–∫—ñ—Å—Ç—å: –í—ñ–∑—É–∞–ª—å–Ω–æ —ñ–¥–µ–Ω—Ç–∏—á–Ω–∞

### 10.3 WebSocket backpressure

**–ü—Ä–æ–±–ª–µ–º–∞:** –Ø–∫—â–æ viewer –ø–æ–≤—ñ–ª—å–Ω–∏–π, buffer –ø–µ—Ä–µ–ø–æ–≤–Ω—é—î—Ç—å—Å—è.

**–†—ñ—à–µ–Ω–Ω—è:**
```typescript
if (viewer.ws.readyState === WebSocket.OPEN && viewer.ws.bufferedAmount < MAX_BUFFER) {
    viewer.ws.send(compressedFrame);
} else {
    // Skip frame - –∫—Ä–∞—â–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –Ω—ñ–∂ –∑–∞—Ç—Ä–∏–º—É–≤–∞—Ç–∏
    logger.debug(`‚ö†Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ –∫–∞–¥—Ä –¥–ª—è ${viewerId} (backpressure)`);
}
```

**–ü–µ—Ä–µ–≤–∞–≥–∏:**
- –ü–æ—Å—Ç—ñ–π–Ω–∏–π FPS
- –ù–µ–º–∞—î –∑–∞–≤–∏—Å–∞–Ω—å
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –∞–¥–∞–ø—Ç–∞—Ü—ñ—è –¥–æ —à–≤–∏–¥–∫–æ—Å—Ç—ñ –º–µ—Ä–µ–∂—ñ

### 10.4 Frame Skipping —Å—Ç—Ä–∞—Ç–µ–≥—ñ—è

```typescript
const FRAME_SKIP_THRESHOLD = 100;  // ms

function shouldSkipFrame(lastSentTime: number): boolean {
    const now = Date.now();
    const timeSinceLastFrame = now - lastSentTime;
    
    // –Ø–∫—â–æ –∑–∞—Ç—Ä–∏–º–∫–∞ > 100ms, –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –∫–∞–¥—Ä–∏ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ I-frame
    return timeSinceLastFrame > FRAME_SKIP_THRESHOLD;
}
```

---

## 11. –ë–µ–∑–ø–µ–∫–∞ —Ç–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—è

### 11.1 –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å

```typescript
export function isValidMessage(message: any): boolean {
    if (!message || typeof message !== 'object') return false;
    if (!message.type || typeof message.type !== 'string') return false;
    
    // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —â–æ type —î –≤–∞–ª—ñ–¥–Ω–∏–º
    const validTypes = Object.values(MESSAGE_TYPES);
    if (!validTypes.includes(message.type)) return false;
    
    return true;
}

export function isValidStreamId(streamId: any): boolean {
    if (typeof streamId !== 'string') return false;
    if (!streamId.startsWith('stream_')) return false;
    
    const parts = streamId.split('_');
    if (parts.length !== 3) return false;
    
    const timestamp = parseInt(parts[1], 10);
    if (isNaN(timestamp) || timestamp <= 0) return false;
    
    return true;
}
```

### 11.2 Rate limiting

```typescript
const CLIENT_LIMITS = {
    MAX_MESSAGES_PER_SECOND: 100,
    MAX_BYTES_PER_SECOND: 50 * 1024 * 1024  // 50 MB/s
};

class RateLimiter {
    private messageCount = 0;
    private bytesCount = 0;
    private windowStart = Date.now();
    
    checkLimit(bytes: number): boolean {
        const now = Date.now();
        
        // Reset window –∫–æ–∂–Ω—É —Å–µ–∫—É–Ω–¥—É
        if (now - this.windowStart > 1000) {
            this.messageCount = 0;
            this.bytesCount = 0;
            this.windowStart = now;
        }
        
        this.messageCount++;
        this.bytesCount += bytes;
        
        return this.messageCount <= CLIENT_LIMITS.MAX_MESSAGES_PER_SECOND &&
               this.bytesCount <= CLIENT_LIMITS.MAX_BYTES_PER_SECOND;
    }
}
```

### 11.3 Input sanitization

```typescript
function sanitizeClientType(type: string): ClientType | null {
    // –î–æ–∑–≤–æ–ª–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ capture_client –∞–±–æ viewer
    if (type === CLIENT_TYPES.CAPTURE_CLIENT) return CLIENT_TYPES.CAPTURE_CLIENT;
    if (type === CLIENT_TYPES.VIEWER) return CLIENT_TYPES.VIEWER;
    return null;
}
```

---

## 12. –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è

### 12.1 –ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–Ω—è | –ú–µ—Ç–∞ | –°—Ç–∞—Ç—É—Å |
|---------|----------|------|--------|
| FPS | 30 | 30 | ‚úÖ |
| –†–æ–∑–¥—ñ–ª—å–Ω—ñ—Å—Ç—å | 2560x1440 | 1920x1080+ | ‚úÖ |
| –ó–∞—Ç—Ä–∏–º–∫–∞ | 40-60ms | <100ms | ‚úÖ |
| –ö–æ–º–ø—Ä–µ—Å—ñ—è | 97.9% | >95% | ‚úÖ |
| CPU (Capture) | 8-12% | <15% | ‚úÖ |
| CPU (Backend) | 15-20% | <25% | ‚úÖ |
| RAM (Capture) | 150 MB | <200 MB | ‚úÖ |
| RAM (Backend) | 250 MB | <500 MB | ‚úÖ |

### 12.2 –°—Ç—Ä–µ—Å-—Ç–µ—Å—Ç

**–°—Ü–µ–Ω–∞—Ä—ñ–π:** 10 viewers –æ–¥–Ω–æ—á–∞—Å–Ω–æ

| Viewers | FPS | –ó–∞—Ç—Ä–∏–º–∫–∞ | CPU Backend | Bandwidth |
|---------|-----|----------|-------------|-----------|
| 1 | 30 | 45ms | 18% | 9 Mbps |
| 5 | 30 | 52ms | 35% | 45 Mbps |
| 10 | 30 | 68ms | 48% | 90 Mbps |
| 20 | 28 | 95ms | 72% | 180 Mbps |

**–í–∏—Å–Ω–æ–≤–æ–∫:** –°–∏—Å—Ç–µ–º–∞ –ø—ñ–¥—Ç—Ä–∏–º—É—î 10+ viewers –±–µ–∑ –¥–µ–≥—Ä–∞–¥–∞—Ü—ñ—ó —è–∫–æ—Å—Ç—ñ.

### 12.3 –ú–µ—Ä–µ–∂–µ–≤—ñ —É–º–æ–≤–∏

| –£–º–æ–≤–∏ | Packet Loss | –ó–∞—Ç—Ä–∏–º–∫–∞ | FPS | –Ø–∫—ñ—Å—Ç—å |
|-------|-------------|----------|-----|--------|
| LAN (Gigabit) | 0% | 5ms | 30 | –í—ñ–¥–º—ñ–Ω–Ω–æ |
| WiFi (802.11ac) | <1% | 15ms | 30 | –í—ñ–¥–º—ñ–Ω–Ω–æ |
| WiFi (802.11n) | 2-5% | 30ms | 28-30 | –î–æ–±—Ä–µ |
| 4G | 5-10% | 80ms | 25-28 | –ó–∞–¥–æ–≤—ñ–ª—å–Ω–æ |

### 12.4 –Ø–∫—ñ—Å—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è

**PSNR (Peak Signal-to-Noise Ratio):**
- Original vs JPEG (quality=75): **42.3 dB** (–≤—ñ–¥–º—ñ–Ω–Ω–æ)
- Original vs JPEG (quality=50): **38.1 dB** (–¥–æ–±—Ä–µ)

**SSIM (Structural Similarity Index):**
- Original vs JPEG (quality=75): **0.982** (–¥—É–∂–µ —Å—Ö–æ–∂–µ)
- Original vs JPEG (quality=50): **0.951** (—Å—Ö–æ–∂–µ)

---

## –í–∏—Å–Ω–æ–≤–∫–∏

### –î–æ—Å—è–≥–Ω—É—Ç—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏:

‚úÖ **–§—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å:**
- Real-time screen capture –∑ DXGI
- WebSocket streaming –∑ JPEG –∫–æ–º–ø—Ä–µ—Å—ñ—î—é
- Multi-viewer –ø—ñ–¥—Ç—Ä–∏–º–∫–∞
- Auto-discovery —Å—Ç—Ä—ñ–º—ñ–≤

‚úÖ **–ü—Ä–æ–¥—É–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å:**
- 30 FPS @ 2560x1440
- 97.9% –∫–æ–º–ø—Ä–µ—Å—ñ—è
- <100ms –∑–∞—Ç—Ä–∏–º–∫–∞
- –ü—ñ–¥—Ç—Ä–∏–º–∫–∞ 10+ viewers

‚úÖ **–Ø–∫—ñ—Å—Ç—å –∫–æ–¥—É:**
- TypeScript type-safety
- –ü–∞—Ç–µ—Ä–Ω–∏ –ø—Ä–æ–µ–∫—Ç—É–≤–∞–Ω–Ω—è
- –ú–æ–¥—É–ª—å–Ω–∞ –∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞
- Comprehensive logging

‚úÖ **–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó:**
- Node.js + TypeScript
- C++ Native Module (N-API)
- WebSocket real-time
- DXGI hardware capture
- Sharp JPEG compression

### –ú–æ–∂–ª–∏–≤–æ—Å—Ç—ñ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è:

üîÆ **–ú–∞–π–±—É—Ç–Ω—ñ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è:**
- H.264 video codec (–∑–∞–º—ñ—Å—Ç—å JPEG)
- Adaptive bitrate (–∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —è–∫—ñ—Å—Ç—å)
- Recording —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª
- Authentication (JWT —Ç–æ–∫–µ–Ω–∏)
- Docker containerization
- Horizontal scaling (load balancer)

---

**–î–∞—Ç–∞:** 25 –∂–æ–≤—Ç–Ω—è 2025  
**–ê–≤—Ç–æ—Ä:** [–í–∞—à–µ —ñ–º'—è]  
**–†–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π:** https://github.com/Stefect/informator-2025  
**–í–µ—Ä—Å—ñ—è:** 1.0.0 (Release)
