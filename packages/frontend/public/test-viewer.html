<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Viewer - Informator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        #video {
            width: 100%;
            max-width: 1280px;
            background: #000;
            border: 2px solid #333;
        }
        #log {
            background: #000;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
            border: 1px solid #333;
        }
        .log-entry {
            margin: 2px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>üß™ Test Viewer</h1>
    
    <div>
        <button onclick="connect()">–ü—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è</button>
        <button onclick="disconnect()">–í—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è</button>
    </div>
    
    <canvas id="video" width="1280" height="720"></canvas>
    
    <div id="stats">
        <p>–°—Ç–∞—Ç—É—Å: <span id="status">–í—ñ–¥–∫–ª—é—á–µ–Ω–æ</span></p>
        <p>Stream ID: <span id="streamId">-</span></p>
        <p>–ö–∞–¥—Ä—ñ–≤ –æ—Ç—Ä–∏–º–∞–Ω–æ: <span id="frames">0</span></p>
    </div>
    
    <div id="log"></div>

    <script>
        let ws = null;
        let streamId = null;
        let frameCount = 0;
        let frameWidth = 1280;
        let frameHeight = 720;
        let lastMetadata = null;
        const canvas = document.getElementById('video');
        const ctx = canvas.getContext('2d');

        function log(message) {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        function connect() {
            const url = 'ws://localhost:3001';
            log(`üîå –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ ${url}...`);
            document.getElementById('status').textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...';
            
            ws = new WebSocket(url);
            ws.binaryType = 'arraybuffer';

            ws.onopen = () => {
                log('‚úÖ WebSocket –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ');
                document.getElementById('status').textContent = '–ü—ñ–¥–∫–ª—é—á–µ–Ω–æ';
                
                // –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —è–∫ viewer
                const identification = {
                    type: 'identification',
                    clientType: 'viewer',
                    version: '2.0.0'
                };
                ws.send(JSON.stringify(identification));
                log('üì§ –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
                
                // –ó–∞–ø–∏—Ç–∞—Ç–∏ –ø–æ—Ç–æ–∫–∏ —á–µ—Ä–µ–∑ 500ms
                setTimeout(requestStreams, 500);
            };

            ws.onmessage = (event) => {
                if (event.data instanceof ArrayBuffer) {
                    // –ë—ñ–Ω–∞—Ä–Ω—ñ –¥–∞–Ω—ñ - –∫–∞–¥—Ä
                    handleFrame(event.data);
                } else {
                    // –¢–µ–∫—Å—Ç - –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
                    try {
                        const message = JSON.parse(event.data);
                        handleMessage(message);
                    } catch (e) {
                        log('‚ùå –ü–æ–º–∏–ª–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥—É: ' + e.message);
                    }
                }
            };

            ws.onclose = () => {
                log('‚ö†Ô∏è WebSocket –≤—ñ–¥–∫–ª—é—á–µ–Ω–æ');
                document.getElementById('status').textContent = '–í—ñ–¥–∫–ª—é—á–µ–Ω–æ';
            };

            ws.onerror = (error) => {
                log('‚ùå WebSocket –ø–æ–º–∏–ª–∫–∞: ' + error);
            };
        }

        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }

        function requestStreams() {
            log('üîç –ó–∞–ø–∏—Ç —Å–ø–∏—Å–∫—É –ø–æ—Ç–æ–∫—ñ–≤...');
            fetch('http://localhost:3001/api/streams')
                .then(r => r.json())
                .then(data => {
                    log(`üìä –û—Ç—Ä–∏–º–∞–Ω–æ ${data.streams.length} –ø–æ—Ç–æ–∫—ñ–≤`);
                    if (data.streams.length > 0) {
                        const stream = data.streams[data.streams.length - 1]; // –û—Å—Ç–∞–Ω–Ω—ñ–π –ø–æ—Ç—ñ–∫
                        streamId = stream.streamId;
                        log(`üéØ –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –ø–æ—Ç–æ–∫—É: ${streamId}`);
                        document.getElementById('streamId').textContent = streamId;
                        
                        // –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –ø–æ—Ç–æ–∫—É
                        const joinMessage = {
                            type: 'join_stream',
                            streamId: streamId
                        };
                        ws.send(JSON.stringify(joinMessage));
                        log('üì§ join_stream –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ');
                    } else {
                        log('‚ö†Ô∏è –ù–µ–º–∞—î –∞–∫—Ç–∏–≤–Ω–∏—Ö –ø–æ—Ç–æ–∫—ñ–≤');
                    }
                })
                .catch(e => log('‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–∞–ø–∏—Ç—É –ø–æ—Ç–æ–∫—ñ–≤: ' + e.message));
        }

        function handleMessage(message) {
            log(`üì• ${message.type}`);
            
            switch (message.type) {
                case 'welcome':
                    log(`üëã Client ID: ${message.clientId}`);
                    break;
                case 'joined_stream':
                    log(`‚úÖ –ü—Ä–∏—î–¥–Ω–∞–ª–∏—Å—è –¥–æ –ø–æ—Ç–æ–∫—É: ${message.streamId}`);
                    break;
                case 'frame_metadata':
                    // –ó–±–µ—Ä–µ–≥—Ç–∏ –º–µ—Ç–∞–¥–∞–Ω—ñ –∫–∞–¥—Ä—É –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ –ø–∞–∫–µ—Ç—É
                    lastMetadata = message;
                    if (frameCount === 0) {
                        log(`üé¨ –ü–µ—Ä—à–∏–π –∫–∞–¥—Ä: ${message.width}x${message.height}, codec: ${message.codec}`);
                    }
                    break;
            }
        }

        function handleFrame(arrayBuffer) {
            frameCount++;
            document.getElementById('frames').textContent = frameCount;
            
            if (frameCount % 10 === 0) {
                log(`üì∫ –û—Ç—Ä–∏–º–∞–Ω–æ –∫–∞–¥—Ä #${frameCount} (${arrayBuffer.byteLength} bytes)`);
            }
            
            // –í—ñ–¥–æ–±—Ä–∞–∑–∏—Ç–∏ –¥–∞–Ω—ñ –Ω–∞ canvas
            try {
                const width = lastMetadata ? lastMetadata.width : frameWidth;
                const height = lastMetadata ? lastMetadata.height : frameHeight;
                const codec = lastMetadata ? lastMetadata.codec : 'unknown';
                
                // –û–Ω–æ–≤–∏—Ç–∏ —Ä–æ–∑–º—ñ—Ä canvas —è–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ
                if (canvas.width !== width || canvas.height !== height) {
                    canvas.width = width;
                    canvas.height = height;
                    log(`üñºÔ∏è Canvas —Ä–æ–∑–º—ñ—Ä: ${width}x${height}`);
                }
                
                if (codec === 'jpeg') {
                    // JPEG —Ñ–æ—Ä–º–∞—Ç - –¥–µ–∫–æ–¥—É–≤–∞—Ç–∏ —á–µ—Ä–µ–∑ Image
                    const blob = new Blob([arrayBuffer], { type: 'image/jpeg' });
                    const imageUrl = URL.createObjectURL(blob);
                    const img = new Image();
                    
                    img.onload = () => {
                        ctx.drawImage(img, 0, 0, width, height);
                        URL.revokeObjectURL(imageUrl);
                    };
                    
                    img.onerror = () => {
                        log('‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–µ–∫–æ–¥—É–≤–∞–Ω–Ω—è JPEG');
                        URL.revokeObjectURL(imageUrl);
                    };
                    
                    img.src = imageUrl;
                    
                } else if (codec === 'bgra') {
                    // BGRA RAW —Ñ–æ—Ä–º–∞—Ç
                    const expectedSize = width * height * 4;
                    
                    if (arrayBuffer.byteLength === expectedSize) {
                        const imageData = ctx.createImageData(width, height);
                        const bgraData = new Uint8Array(arrayBuffer);
                        
                        // –ö–æ–Ω–≤–µ—Ä—Ç—É–≤–∞—Ç–∏ BGRA -> RGBA –¥–ª—è Canvas
                        for (let i = 0; i < bgraData.length; i += 4) {
                            imageData.data[i + 0] = bgraData[i + 2]; // R
                            imageData.data[i + 1] = bgraData[i + 1]; // G
                            imageData.data[i + 2] = bgraData[i + 0]; // B
                            imageData.data[i + 3] = 255;              // A
                        }
                        
                        ctx.putImageData(imageData, 0, 0);
                    } else {
                        log(`‚ö†Ô∏è BGRA —Ä–æ–∑–º—ñ—Ä –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—î: ${arrayBuffer.byteLength} vs ${expectedSize}`);
                    }
                } else {
                    // –ù–µ–≤—ñ–¥–æ–º–∏–π —Ñ–æ—Ä–º–∞—Ç
                    log(`‚ö†Ô∏è –ù–µ–≤—ñ–¥–æ–º–∏–π codec: ${codec}`);
                    ctx.fillStyle = '#ff0000';
                    ctx.fillRect(0, 0, width, height);
                    ctx.fillStyle = '#fff';
                    ctx.font = '32px Arial';
                    ctx.fillText(`–ù–µ–≤—ñ–¥–æ–º–∏–π —Ñ–æ—Ä–º–∞—Ç: ${codec}`, 50, height / 2);
                }
            } catch (e) {
                log(`‚ùå –ü–æ–º–∏–ª–∫–∞ –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó: ${e.message}`);
            }
        }
    </script>
</body>
</html>
